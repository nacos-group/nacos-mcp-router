FROM python:3.12-slim

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV NACOS_HOME=/opt/nacos
ENV JAVA_HOME=/usr/lib/jvm/java-8-openjdk-amd64
ENV PATH=$PATH:$JAVA_HOME/bin:$NACOS_HOME/bin

# å®‰è£…ç³»ç»Ÿä¾èµ–
RUN apt-get update && apt-get install -y \
    build-essential \
    curl \
    wget \
    unzip \
    jq \
    openjdk-8-jdk \
    procps \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# å¤åˆ¶Pythonä»£ç 
COPY src/python .

# ä¸‹è½½æœ€æ–°ç‰ˆæœ¬çš„Nacos Server
RUN echo "Fetching latest Nacos release..." && \
    LATEST_RELEASE=$(curl -s https://api.github.com/repos/alibaba/nacos/releases/latest | jq -r '.tag_name') && \
    echo "Latest Nacos version: $LATEST_RELEASE" && \
    NACOS_DOWNLOAD_URL="https://github.com/alibaba/nacos/releases/download/${LATEST_RELEASE}/nacos-server-${LATEST_RELEASE}.tar.gz" && \
    echo "Download URL: $NACOS_DOWNLOAD_URL" && \
    wget -O /tmp/nacos-server.tar.gz "$NACOS_DOWNLOAD_URL" && \
    mkdir -p $NACOS_HOME && \
    tar -xzf /tmp/nacos-server.tar.gz -C /tmp && \
    mv /tmp/nacos/* $NACOS_HOME/ && \
    rm -rf /tmp/nacos-server.tar.gz /tmp/nacos && \
    chmod +x $NACOS_HOME/bin/*.sh && \
    echo $LATEST_RELEASE > $NACOS_HOME/VERSION

# åˆ›å»ºNacosæ•°æ®ç›®å½•
RUN mkdir -p $NACOS_HOME/data $NACOS_HOME/logs

# å‡†å¤‡ChromaDBæ¨¡å‹æ–‡ä»¶
RUN mkdir -p /root/.cache/chroma/onnx_models/all-MiniLM-L6-v2/ && \
    curl -v https://chroma-onnx-models.s3.amazonaws.com/all-MiniLM-L6-v2/onnx.tar.gz \
    -o /root/.cache/chroma/onnx_models/all-MiniLM-L6-v2/onnx.tar.gz

# å®‰è£…Pythonä¾èµ–
RUN pip install --no-cache-dir .

# åˆ›å»ºå¯åŠ¨è„šæœ¬
RUN cat > /app/start.sh << 'EOF'
#!/bin/bash
set -e

# è·å–Nacosç‰ˆæœ¬
NACOS_VERSION=$(cat $NACOS_HOME/VERSION 2>/dev/null || echo "unknown")

# é»˜è®¤ç¯å¢ƒå˜é‡
export MODE=${MODE:-standalone}
export NACOS_AUTH_TOKEN=${NACOS_AUTH_TOKEN:-VGhpc0lzTXlTZWNyZXRLZXlGb3JOYWNvc01DUFJvdXRlcjEyMzQ1Njc4OTA=}
export NACOS_AUTH_IDENTITY_KEY=${NACOS_AUTH_IDENTITY_KEY:-nacos-server-identity}
export NACOS_AUTH_IDENTITY_VALUE=${NACOS_AUTH_IDENTITY_VALUE:-nacos-server-value}
export NACOS_AUTH_ENABLE=${NACOS_AUTH_ENABLE:-true}
export SPRING_SECURITY_ENABLED=${SPRING_SECURITY_ENABLED:-true}
export NACOS_PASSWORD=${NACOS_PASSWORD:-nacos}

# Routerç¯å¢ƒå˜é‡
export NACOS_ADDR=${NACOS_ADDR:-127.0.0.1:8848}
export NACOS_USERNAME=${NACOS_USERNAME:-nacos}
export TRANSPORT_TYPE=${TRANSPORT_TYPE:-stdio}
export ROUTER_MODE=${ROUTER_MODE:-router}

echo "========================================"
echo "ğŸš€ Starting Nacos MCP Router Container"
echo "========================================"
echo "ğŸ“¦ Nacos Version: $NACOS_VERSION"
echo "ğŸ”§ Nacos Mode: $MODE"
echo "ğŸ”€ Router Mode: $ROUTER_MODE"
echo "ğŸ“¡ Transport Type: $TRANSPORT_TYPE"
echo "========================================"

# å¯åŠ¨Nacos Server
echo "ğŸ”„ Starting Nacos Server..."
cd $NACOS_HOME

# ç¡®ä¿æ—¥å¿—ç›®å½•å­˜åœ¨
mkdir -p logs

# å¯åŠ¨Nacos
nohup sh bin/startup.sh -m $MODE > logs/nacos-startup.log 2>&1 &
NACOS_PID=$!

echo "ğŸ“ Nacos started with PID: $NACOS_PID"
echo "â³ Waiting for Nacos to be ready..."

# ç­‰å¾…Nacoså¯åŠ¨å®Œæˆ
max_attempts=60
attempt=0
while [ $attempt -lt $max_attempts ]; do
    if curl -f -s http://localhost:8848/nacos/actuator/health >/dev/null 2>&1; then
        echo "âœ… Nacos is ready!"
        break
    fi
    echo "â³ Attempt $((attempt+1))/$max_attempts: Nacos not ready yet, waiting..."
    
    # æ¯10æ¬¡å°è¯•è¾“å‡ºä¸€æ¬¡æ—¥å¿—ç‰‡æ®µ
    if [ $((attempt % 10)) -eq 0 ] && [ $attempt -gt 0 ]; then
        echo "ğŸ“‹ Recent Nacos log:"
        tail -5 logs/nacos-startup.log 2>/dev/null || echo "No log available yet"
    fi
    
    sleep 5
    attempt=$((attempt+1))
done

if [ $attempt -eq $max_attempts ]; then
    echo "âŒ Nacos failed to start within expected time"
    echo "=== ğŸ“‹ Nacos startup log ==="
    cat logs/nacos-startup.log 2>/dev/null || echo "No log file found"
    echo "========================="
    
    # æ£€æŸ¥Javaè¿›ç¨‹
    echo "=== ğŸ” Process status ==="
    ps aux | grep java || echo "No Java processes found"
    echo "========================="
    
    exit 1
fi

# éªŒè¯NacosæœåŠ¡
echo "ğŸ” Verifying Nacos services..."
curl -s http://localhost:8848/nacos/actuator/health | jq . 2>/dev/null || echo "Health check response received"

# æ˜¾ç¤ºNacosä¿¡æ¯
echo "========================================"
echo "âœ… Nacos Server is ready!"
echo "ğŸŒ Console: http://localhost:8848/nacos"
echo "ğŸ‘¤ Username: nacos"
echo "ğŸ”‘ Password: $NACOS_PASSWORD"
echo "========================================"

# å¯åŠ¨Router
echo "ğŸ”„ Starting nacos-mcp-router..."
cd /app

# æœ€åæ£€æŸ¥ä¸€æ¬¡NacosçŠ¶æ€
if ! curl -f -s http://localhost:8848/nacos/actuator/health >/dev/null 2>&1; then
    echo "âŒ Nacos health check failed before starting router"
    exit 1
fi

echo "ğŸš€ Starting Router with config:"
echo "   NACOS_ADDR: $NACOS_ADDR"
echo "   NACOS_USERNAME: $NACOS_USERNAME"
echo "   TRANSPORT_TYPE: $TRANSPORT_TYPE"
echo "   MODE: $ROUTER_MODE"

exec python -m nacos_mcp_router
EOF

# ç»™å¯åŠ¨è„šæœ¬æ‰§è¡Œæƒé™
RUN chmod +x /app/start.sh

# æš´éœ²ç«¯å£
EXPOSE 8080 8848 9848 8000

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=90s --retries=3 \
    CMD curl -f http://localhost:8848/nacos/actuator/health || exit 1

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# å¯åŠ¨æœåŠ¡
CMD ["/app/start.sh"] 